# ä¸ªäººçŸ¥è¯†ç®¡ç†Agentç³»ç»Ÿ - æ•°æ®åº“è®¾è®¡æ–‡æ¡£

## æ–‡æ¡£ä¿¡æ¯
- **ç‰ˆæœ¬**: v1.0.0
- **åˆ›å»ºæ—¥æœŸ**: 2025-11-07
- **é€‚ç”¨äººå‘˜**: æ•°æ®åº“ç®¡ç†å‘˜ã€åç«¯å¼€å‘ã€æ¶æ„å¸ˆ

---

## 1. æ•°æ®åº“æ¦‚è¿°

### 1.1 æ•°æ®åº“æŠ€æœ¯é€‰å‹

æœ¬ç³»ç»Ÿé‡‡ç”¨ **ChromaDB** ä½œä¸ºä¸»è¦å‘é‡æ•°æ®åº“ï¼ŒChromaDBæ˜¯ä¸€ä¸ªè½»é‡çº§ã€å¼€æºçš„å‘é‡æ•°æ®åº“ï¼Œä¸“ä¸ºAIåº”ç”¨è®¾è®¡ã€‚

| æ•°æ®åº“ç±»å‹ | æŠ€æœ¯æ–¹æ¡ˆ | ç”¨é€” | å­˜å‚¨ä½ç½® |
|-----------|---------|------|---------|
| **å‘é‡æ•°æ®åº“** | ChromaDB | æ–‡æ¡£å‘é‡å­˜å‚¨ã€è¯­ä¹‰æ£€ç´¢ | `./data/vector_db/` |
| **å…ƒæ•°æ®å­˜å‚¨** | ChromaDBå†…ç½® | æ–‡æ¡£å…ƒæ•°æ®ã€ç´¢å¼• | ChromaDBé›†åˆå†… |

### 1.2 ä¸ºä»€ä¹ˆé€‰æ‹©ChromaDB?

âœ… **ä¼˜åŠ¿**:
- ğŸš€ **è½»é‡çº§**: æ— éœ€å¤æ‚é…ç½®ï¼ŒåµŒå…¥å¼è¿è¡Œ
- ğŸ’¾ **æŒä¹…åŒ–**: è‡ªåŠ¨æœ¬åœ°æŒä¹…åŒ–ï¼Œæ•°æ®ä¸ä¸¢å¤±
- ğŸ” **é«˜æ•ˆæ£€ç´¢**: åŸºäºHNSWç®—æ³•çš„å¿«é€Ÿå‘é‡æœç´¢
- ğŸ **PythonåŸç”Ÿ**: å®Œç¾é›†æˆPythonç”Ÿæ€
- ğŸ’° **å®Œå…¨å…è´¹**: å¼€æºæ— é™åˆ¶ä½¿ç”¨
- ğŸ”’ **éšç§ä¿æŠ¤**: æœ¬åœ°å­˜å‚¨ï¼Œæ•°æ®ä¸ä¸Šäº‘

---

## 2. ChromaDB æ¶æ„è®¾è®¡

### 2.1 Collection (é›†åˆ) æ¦‚å¿µ

ChromaDBä½¿ç”¨ **Collection** ä½œä¸ºæ ¸å¿ƒå­˜å‚¨å•å…ƒï¼Œç±»ä¼¼äºä¼ ç»Ÿæ•°æ®åº“çš„"è¡¨"ã€‚

```python
# åˆ›å»º/è·å–é›†åˆ
collection = client.get_or_create_collection(
    name="knowledge_base",
    metadata={"description": "ä¸ªäººçŸ¥è¯†åº“å‘é‡å­˜å‚¨"}
)
```

**æœ¬ç³»ç»Ÿä½¿ç”¨çš„Collection**:
- **åç§°**: `knowledge_base`
- **ç”¨é€”**: å­˜å‚¨æ‰€æœ‰æ–‡æ¡£çš„å‘é‡å’Œå…ƒæ•°æ®

### 2.2 æ•°æ®å­˜å‚¨ç»“æ„

ChromaDBä¸­æ¯æ¡è®°å½•åŒ…å«ä»¥ä¸‹å­—æ®µ:

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| **id** | str | å”¯ä¸€æ–‡æ¡£ID | `doc_hash123_0` |
| **embedding** | List[float] | å‘é‡è¡¨ç¤º | `[0.123, -0.456, ...]` |
| **document** | str | æ–‡æ¡£æ–‡æœ¬å†…å®¹ | `"Pythonè£…é¥°å™¨æ˜¯..."` |
| **metadata** | dict | å…ƒæ•°æ®å­—å…¸ | `{"filename": "notes.md"}` |

**å­˜å‚¨ç¤ºä¾‹**:
```python
collection.add(
    ids=["doc_hash123_0", "doc_hash123_1"],
    embeddings=[
        [0.123, 0.456, ...],  # 384ç»´å‘é‡
        [0.789, 0.012, ...]
    ],
    documents=[
        "Pythonè£…é¥°å™¨æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼...",
        "è£…é¥°å™¨å¯ä»¥åœ¨ä¸ä¿®æ”¹åŸå‡½æ•°çš„æƒ…å†µä¸‹..."
    ],
    metadatas=[
        {
            "filename": "python_notes.md",
            "chunk_id": 0,
            "total_chunks": 2,
            "category": "å­¦ä¹ ",
            # ... æ›´å¤šå…ƒæ•°æ®
        },
        {
            "filename": "python_notes.md",
            "chunk_id": 1,
            "total_chunks": 2,
            "category": "å­¦ä¹ "
        }
    ]
)
```

---

## 3. å…ƒæ•°æ®Schemaè®¾è®¡

### 3.1 æ ¸å¿ƒå…ƒæ•°æ®å­—æ®µ

æ‰€æœ‰æ–‡æ¡£å—å­˜å‚¨æ—¶åŒ…å«ä»¥ä¸‹å…ƒæ•°æ®:

| å­—æ®µå | æ•°æ®ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|--------|---------|------|------|------|
| **source** | str | âœ… | æ–‡ä»¶ç»å¯¹è·¯å¾„ | `/path/to/file.pdf` |
| **filename** | str | âœ… | æ–‡ä»¶å | `python_notes.md` |
| **file_type** | str | âœ… | æ–‡ä»¶æ‰©å±•å | `.pdf` |
| **file_size** | float | âœ… | æ–‡ä»¶å¤§å°(MB) | `2.5` |
| **chunk_id** | int | âœ… | æ–‡æ¡£å—ç´¢å¼• | `0` |
| **total_chunks** | int | âœ… | æ€»å—æ•° | `5` |
| **content_hash** | str | âœ… | å†…å®¹å“ˆå¸Œå€¼ | `hash_12345` |
| **category** | str | âœ… | æ–‡æ¡£åˆ†ç±» | `å­¦ä¹ ` |
| **priority** | str | âŒ | ä¼˜å…ˆçº§ | `é«˜` |
| **summary** | str | âŒ | æ–‡æ¡£æ‘˜è¦ | `å…³äºPythonè£…é¥°å™¨...` |
| **tags** | str | âŒ | æ ‡ç­¾(é€—å·åˆ†éš”) | `Python,è£…é¥°å™¨,å­¦ä¹ ` |
| **confidence** | float | âŒ | åˆ†ç±»ç½®ä¿¡åº¦ | `0.85` |

### 3.2 æ£€ç´¢æ—¶åŠ¨æ€æ·»åŠ çš„å­—æ®µ

æœç´¢ç»“æœè¿”å›æ—¶ï¼Œç³»ç»Ÿä¼šæ·»åŠ ä»¥ä¸‹å­—æ®µ:

| å­—æ®µå | æ•°æ®ç±»å‹ | è¯´æ˜ | å–å€¼èŒƒå›´ |
|--------|---------|------|---------|
| **search_score** | float | è·ç¦»åˆ†æ•° | `0.0 - 2.0+` |
| **relevance_score** | float | ç›¸å…³æ€§åˆ†æ•° | `0.0 - 1.0` |
| **doc_id** | str | ChromaDBæ–‡æ¡£ID | `doc_xxx` |
| **vector_score** | float | å‘é‡æœç´¢åˆ†æ•°(æ··åˆæ£€ç´¢æ—¶) | `0.0 - 1.0` |
| **keyword_score** | float | å…³é”®è¯åˆ†æ•°(æ··åˆæ£€ç´¢æ—¶) | `0.0 - 1.0` |
| **combined_score** | float | ç»¼åˆåˆ†æ•°(æ··åˆæ£€ç´¢æ—¶) | `0.0 - 1.0` |

### 3.3 å…ƒæ•°æ®å­—æ®µè¯¦è§£

#### 3.3.1 category (åˆ†ç±»)
**é¢„å®šä¹‰åˆ†ç±»**:
- `å·¥ä½œ`: èŒä¸šç›¸å…³æ–‡æ¡£ã€ä»»åŠ¡ã€è®¡åˆ’ã€æŠ¥å‘Š
- `å­¦ä¹ `: æ•™è‚²ææ–™ã€æ•™ç¨‹ã€è¯¾ç¨‹ç¬”è®°ã€æŠ€èƒ½å­¦ä¹ 
- `ä¸ªäºº`: æ—¥è®°ã€æƒ³æ³•æ„Ÿæ‚Ÿã€ç”Ÿæ´»è®°å½•
- `å‚è€ƒ`: æ‰‹å†Œã€æŒ‡å—ã€è§„èŒƒã€æ ‡å‡†ã€å‚è€ƒèµ„æ–™
- `ç ”ç©¶`: åˆ†ææŠ¥å‘Šã€å®éªŒæ•°æ®ã€ç ”ç©¶å‘ç°
- `æƒ³æ³•`: åˆ›æ„ã€åˆ›æ–°ã€è®¾è®¡ç†å¿µã€æ¦‚å¿µæ„æ€

**åˆ†ç±»è§„åˆ™**: åŸºäºå…³é”®è¯åŒ¹é…ï¼ˆè§ `DocumentClassifier`ï¼‰

#### 3.3.2 priority (ä¼˜å…ˆçº§)
**çº§åˆ«å®šä¹‰**:
- `é«˜`: åŒ…å«"é‡è¦"ã€"urgent"ã€"ç´§æ€¥"å…³é”®è¯
- `ä¸­`: æ–‡æ¡£é•¿åº¦ > 2000å­—ç¬¦
- `ä½`: å…¶ä»–æ–‡æ¡£

#### 3.3.3 tags (æ ‡ç­¾)
**æ ¼å¼**: é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²
**ç¤ºä¾‹**: `"Python,è£…é¥°å™¨,é«˜çº§ç‰¹æ€§,ç¼–ç¨‹"`
**ç”Ÿæˆæ–¹å¼**: è‡ªåŠ¨æå–é«˜é¢‘è¯æ±‡

---

## 4. å‘é‡å­˜å‚¨è®¾è®¡

### 4.1 Embeddingå‘é‡

**å‘é‡ç»´åº¦** (æ ¹æ®embeddingæ–¹æ¡ˆ):
| æ–¹æ¡ˆ | ç»´åº¦ | è¯´æ˜ |
|------|------|------|
| Sentence Transformers | 384 | å…è´¹æ¨èæ–¹æ¡ˆ |
| æ–‡æœ¬å“ˆå¸Œ | 384 | é›¶ä¾èµ–å¤‡ç”¨æ–¹æ¡ˆ |
| TF-IDF | 1000 | å…³é”®è¯ä¼˜åŒ–æ–¹æ¡ˆ |
| OpenAI | 1536 | é«˜è´¨é‡ä»˜è´¹æ–¹æ¡ˆ |

**å‘é‡ç”Ÿæˆæµç¨‹**:
```
æ–‡æ¡£æ–‡æœ¬ â†’ Embeddingæ¨¡å‹ â†’ 384ç»´æµ®ç‚¹å‘é‡
ä¾‹å¦‚: "Pythonè£…é¥°å™¨..." â†’ [0.123, -0.456, 0.789, ...]
```

### 4.2 å‘é‡ç´¢å¼•ç®—æ³•

ChromaDBé»˜è®¤ä½¿ç”¨ **HNSW (Hierarchical Navigable Small World)** ç´¢å¼•:

**HNSWç‰¹æ€§**:
- âš¡ **å¿«é€Ÿæ£€ç´¢**: O(log N) æŸ¥è¯¢å¤æ‚åº¦
- ğŸ“ˆ **å¯æ‰©å±•**: æ”¯æŒç™¾ä¸‡çº§å‘é‡
- ğŸ¯ **é«˜å‡†ç¡®ç‡**: è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢

**è·ç¦»åº¦é‡**: æ¬§å‡ é‡Œå¾—è·ç¦» (Euclidean Distance)
```python
distance = sqrt(sum((a[i] - b[i])^2 for i in range(dim)))
```

### 4.3 ç›¸ä¼¼åº¦è®¡ç®—

**ç›¸å…³æ€§åˆ†æ•°è®¡ç®—** (`vector_store_simple.py`):
```python
# 1. å½’ä¸€åŒ–è·ç¦»åˆ° [0, 1]
relative_distance = (distance - min_distance) / (max_distance - min_distance)

# 2. è½¬æ¢ä¸ºç›¸å…³æ€§åˆ†æ•°
relevance_score = 1.0 - relative_distance

# 3. æ ¹æ®è·ç¦»é˜ˆå€¼è°ƒæ•´
if distance > 2.0:  # è·ç¦»å¾ˆè¿œ
    relevance_score = max(0.0, min(0.3, relevance_score))
elif distance > 1.5:  # è·ç¦»è¾ƒè¿œ
    relevance_score = max(0.1, min(0.5, relevance_score))
elif distance < 0.3:  # éå¸¸ç›¸ä¼¼
    relevance_score = max(0.7, min(1.0, relevance_score))
else:  # ä¸­ç­‰è·ç¦»
    relevance_score = max(0.2, min(0.8, relevance_score))
```

---

## 5. æ•°æ®æŒä¹…åŒ–

### 5.1 å­˜å‚¨ä½ç½®

**é»˜è®¤è·¯å¾„**: `./data/vector_db/`

**ç›®å½•ç»“æ„**:
```
data/
â””â”€â”€ vector_db/
    â”œâ”€â”€ chroma.sqlite3           # ChromaDB SQLiteæ•°æ®åº“
    â”œâ”€â”€ <collection_id_1>/       # Collectionæ•°æ®ç›®å½•
    â”‚   â”œâ”€â”€ data_level0.bin     # HNSWç´¢å¼•æ•°æ®
    â”‚   â”œâ”€â”€ header.bin          # ç´¢å¼•å¤´ä¿¡æ¯
    â”‚   â”œâ”€â”€ length.bin          # å‘é‡é•¿åº¦ä¿¡æ¯
    â”‚   â””â”€â”€ link_lists.bin      # HNSWé“¾æ¥åˆ—è¡¨
    â””â”€â”€ <collection_id_2>/
        â””â”€â”€ ...
```

### 5.2 æŒä¹…åŒ–æœºåˆ¶

**è‡ªåŠ¨æŒä¹…åŒ–**:
- ChromaDBåœ¨æ¯æ¬¡ `add()` / `delete()` / `update()` æ“ä½œåè‡ªåŠ¨ä¿å­˜
- æ— éœ€æ‰‹åŠ¨è°ƒç”¨ `commit()` æˆ– `flush()`

**æ•°æ®å®‰å…¨**:
- âœ… æœ¬åœ°ç£ç›˜å­˜å‚¨
- âœ… æ”¯æŒå¤‡ä»½å’Œè¿ç§»ï¼ˆå¤åˆ¶æ•´ä¸ª `vector_db` ç›®å½•ï¼‰
- âœ… å´©æºƒæ¢å¤èƒ½åŠ›

### 5.3 å¤‡ä»½ä¸æ¢å¤

**å¤‡ä»½**:
```bash
# åœæ­¢åº”ç”¨
# å¤åˆ¶æ•´ä¸ªå‘é‡æ•°æ®åº“ç›®å½•
cp -r ./data/vector_db ./backup/vector_db_20250107
```

**æ¢å¤**:
```bash
# åœæ­¢åº”ç”¨
# åˆ é™¤å½“å‰æ•°æ®åº“
rm -rf ./data/vector_db
# æ¢å¤å¤‡ä»½
cp -r ./backup/vector_db_20250107 ./data/vector_db
```

---

## 6. æŸ¥è¯¢æ“ä½œè®¾è®¡

### 6.1 å‘é‡ç›¸ä¼¼åº¦æŸ¥è¯¢

**åŸºæœ¬æŸ¥è¯¢**:
```python
results = collection.query(
    query_embeddings=[query_vector],  # æŸ¥è¯¢å‘é‡
    n_results=5,                      # è¿”å›Top-5
    where={"category": {"$eq": "å­¦ä¹ "}} # å…ƒæ•°æ®è¿‡æ»¤(å¯é€‰)
)
```

**è¿”å›ç»“æœç»“æ„**:
```python
{
    'ids': [['doc_1', 'doc_2', 'doc_3']],
    'distances': [[0.35, 0.52, 0.68]],
    'documents': [['æ–‡æ¡£1å†…å®¹...', 'æ–‡æ¡£2å†…å®¹...', 'æ–‡æ¡£3å†…å®¹...']],
    'metadatas': [[
        {'filename': 'notes.md', 'category': 'å­¦ä¹ '},
        {'filename': 'guide.pdf', 'category': 'å‚è€ƒ'},
        # ...
    ]]
}
```

### 6.2 å…ƒæ•°æ®è¿‡æ»¤æŸ¥è¯¢

**æ”¯æŒçš„è¿‡æ»¤æ“ä½œç¬¦**:
| æ“ä½œç¬¦ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `$eq` | ç­‰äº | `{"category": {"$eq": "å­¦ä¹ "}}` |
| `$ne` | ä¸ç­‰äº | `{"category": {"$ne": "ä¸´æ—¶"}}` |
| `$gt` | å¤§äº | `{"file_size": {"$gt": 1.0}}` |
| `$gte` | å¤§äºç­‰äº | `{"chunk_id": {"$gte": 0}}` |
| `$lt` | å°äº | `{"file_size": {"$lt": 10.0}}` |
| `$lte` | å°äºç­‰äº | `{"chunk_id": {"$lte": 5}}` |
| `$in` | åœ¨åˆ—è¡¨ä¸­ | `{"category": {"$in": ["å­¦ä¹ ", "å·¥ä½œ"]}}` |

**ç»„åˆè¿‡æ»¤**:
```python
where = {
    "$and": [
        {"category": {"$eq": "å­¦ä¹ "}},
        {"file_size": {"$lt": 5.0}}
    ]
}
```

### 6.3 åˆ é™¤æ“ä½œ

**æŒ‰æ¡ä»¶åˆ é™¤**:
```python
collection.delete(
    where={"filename": {"$eq": "old_document.pdf"}}
)
```

**åˆ é™¤å…¨éƒ¨**:
```python
client.delete_collection("knowledge_base")
client.create_collection("knowledge_base")
```

---

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 ç´¢å¼•ä¼˜åŒ–

**HNSWå‚æ•°** (ChromaDBé»˜è®¤):
- `M`: 16 (æ¯å±‚æœ€å¤§è¿æ¥æ•°)
- `ef_construction`: 200 (æ„å»ºæ—¶æœç´¢èŒƒå›´)
- `ef_search`: 10 (æŸ¥è¯¢æ—¶æœç´¢èŒƒå›´)

**ä¼˜åŒ–å»ºè®®**:
- ğŸ“Š **å°æ•°æ®é›†** (<10K): é»˜è®¤å‚æ•°å³å¯
- ğŸ“ˆ **ä¸­æ•°æ®é›†** (10K-100K): å¢åŠ  `M` åˆ° 32
- ğŸš€ **å¤§æ•°æ®é›†** (>100K): ä½¿ç”¨ä¸“ç”¨å‘é‡æ•°æ®åº“(Milvus, Qdrant)

### 7.2 æŸ¥è¯¢ä¼˜åŒ–

**Top-Ké™åˆ¶**:
```python
# âœ… é™åˆ¶è¿”å›æ•°é‡
results = collection.query(..., n_results=5)

# âŒ é¿å…è¿‡å¤šç»“æœ
results = collection.query(..., n_results=1000)  # æ€§èƒ½ä¸‹é™
```

**å…ƒæ•°æ®è¿‡æ»¤ä¼˜å…ˆ**:
```python
# âœ… å…ˆè¿‡æ»¤å†æ£€ç´¢
where = {"category": {"$eq": "å­¦ä¹ "}}
results = collection.query(..., where=where)

# âŒ æ£€ç´¢åå†è¿‡æ»¤
all_results = collection.query(...)
filtered = [r for r in all_results if r['category'] == 'å­¦ä¹ ']
```

### 7.3 æ‰¹é‡æ“ä½œä¼˜åŒ–

**æ‰¹é‡æ’å…¥**:
```python
# âœ… ä¸€æ¬¡æ€§æ’å…¥å¤šä¸ªæ–‡æ¡£
collection.add(
    ids=[...],
    embeddings=[...],
    documents=[...],
    metadatas=[...]
)

# âŒ é¿å…å¾ªç¯æ’å…¥
for doc in documents:
    collection.add(ids=[...], ...)  # æ¯æ¬¡éƒ½æœ‰IOå¼€é”€
```

---

## 8. æ•°æ®ç»Ÿè®¡ä¸ç›‘æ§

### 8.1 æ•°æ®åº“ç»Ÿè®¡

**è·å–ç»Ÿè®¡ä¿¡æ¯**:
```python
# æ–‡æ¡£æ€»æ•°
total_docs = collection.count()

# è·å–æ‰€æœ‰æ–‡æ¡£ID
all_ids = collection.get()['ids']

# æŒ‰åˆ†ç±»ç»Ÿè®¡
stats = {}
for metadata in collection.get()['metadatas']:
    category = metadata.get('category', 'æœªçŸ¥')
    stats[category] = stats.get(category, 0) + 1
```

### 8.2 å­˜å‚¨ç©ºé—´ç›‘æ§

**ç£ç›˜å ç”¨**:
```python
import os
from pathlib import Path

db_path = Path("./data/vector_db")
total_size = sum(
    f.stat().st_size for f in db_path.rglob('*') if f.is_file()
)
print(f"æ•°æ®åº“å¤§å°: {total_size / (1024**2):.2f} MB")
```

**ä¼°ç®—å…¬å¼**:
```
å•æ¡è®°å½•å¤§å° â‰ˆ å‘é‡ç»´åº¦ Ã— 4å­—èŠ‚ + æ–‡æ¡£æ–‡æœ¬å¤§å° + å…ƒæ•°æ®å¤§å°
384ç»´å‘é‡ â‰ˆ 1.5KB (å‘é‡) + æ–‡æœ¬å¤§å° + 0.5KB (å…ƒæ•°æ®)
```

---

## 9. æ•°æ®è¿ç§»ä¸ç»´æŠ¤

### 9.1 æ•°æ®å¯¼å‡º

**å¯¼å‡ºä¸ºJSON**:
```python
import json

# è·å–æ‰€æœ‰æ•°æ®
data = collection.get()

# å¯¼å‡º
export_data = {
    'ids': data['ids'],
    'documents': data['documents'],
    'metadatas': data['metadatas']
}

with open('backup.json', 'w', encoding='utf-8') as f:
    json.dump(export_data, f, ensure_ascii=False, indent=2)
```

### 9.2 æ•°æ®å¯¼å…¥

**ä»JSONå¯¼å…¥**:
```python
import json

with open('backup.json', 'r', encoding='utf-8') as f:
    import_data = json.load(f)

# é‡æ–°ç”Ÿæˆembedding
embeddings = embedding_manager.embed_documents(import_data['documents'])

# å¯¼å…¥åˆ°æ•°æ®åº“
collection.add(
    ids=import_data['ids'],
    embeddings=embeddings,
    documents=import_data['documents'],
    metadatas=import_data['metadatas']
)
```

### 9.3 æ•°æ®æ¸…ç†

**æ¸…ç†é‡å¤æ–‡æ¡£**:
```python
# åŸºäºcontent_hashå»é‡
seen_hashes = set()
duplicate_ids = []

for doc_id, metadata in zip(data['ids'], data['metadatas']):
    content_hash = metadata.get('content_hash')
    if content_hash in seen_hashes:
        duplicate_ids.append(doc_id)
    else:
        seen_hashes.add(content_hash)

# åˆ é™¤é‡å¤
if duplicate_ids:
    collection.delete(ids=duplicate_ids)
```

---

## 10. å®‰å…¨ä¸æƒé™

### 10.1 æ•°æ®å®‰å…¨

- âœ… **æœ¬åœ°å­˜å‚¨**: æ•°æ®ä¸ä¸Šä¼ äº‘ç«¯
- âœ… **è®¿é—®æ§åˆ¶**: æ–‡ä»¶ç³»ç»Ÿæƒé™æ§åˆ¶
- âœ… **å¤‡ä»½ç­–ç•¥**: å®šæœŸå¤‡ä»½å‘é‡æ•°æ®åº“

### 10.2 æ•°æ®éšç§

- ğŸ”’ æ‰€æœ‰æ–‡æ¡£å†…å®¹æœ¬åœ°å¤„ç†
- ğŸ”’ Embeddingç”Ÿæˆå¯é€‰æœ¬åœ°æ–¹æ¡ˆ
- ğŸ”’ æ— éœ€æ‹…å¿ƒæ•°æ®æ³„éœ²åˆ°ç¬¬ä¸‰æ–¹

---

## 11. æ•°æ®åº“Schemaæ€»ç»“

### 11.1 Collection Schema

**Collectionåç§°**: `knowledge_base`

**å®Œæ•´Schema**:
```python
{
    "id": "doc_hash123_0",  # å”¯ä¸€ID
    "embedding": [0.123, -0.456, ...],  # 384ç»´å‘é‡
    "document": "æ–‡æ¡£æ–‡æœ¬å†…å®¹...",  # æ–‡æœ¬å†…å®¹
    "metadata": {
        # æ–‡ä»¶åŸºæœ¬ä¿¡æ¯
        "source": "/path/to/file.pdf",
        "filename": "file.pdf",
        "file_type": ".pdf",
        "file_size": 2.5,
        
        # åˆ†å—ä¿¡æ¯
        "chunk_id": 0,
        "total_chunks": 5,
        "content_hash": "hash_value",
        
        # åˆ†ç±»ä¿¡æ¯
        "category": "å­¦ä¹ ",
        "priority": "é«˜",
        "summary": "æ–‡æ¡£æ‘˜è¦...",
        "tags": "Python,å­¦ä¹ ",
        "confidence": 0.85,
        
        # æ£€ç´¢æ—¶æ·»åŠ çš„å­—æ®µ
        "search_score": 0.35,
        "relevance_score": 0.75,
        "doc_id": "doc_xxx"
    }
}
```

### 11.2 ERå›¾ (æ¦‚å¿µæ¨¡å‹)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Collection (é›†åˆ)            â”‚
â”‚      knowledge_base                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ åŒ…å«å¤šæ¡
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Document Record             â”‚
â”‚  (æ–‡æ¡£è®°å½• - ChromaDBå†…éƒ¨ç»“æ„)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ id: str (PK)                      â”‚
â”‚ â€¢ embedding: List[float]            â”‚
â”‚ â€¢ document: str                     â”‚
â”‚ â€¢ metadata: dict                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ metadataå­—æ®µ
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Metadata (å…ƒæ•°æ®)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ filename (ç´¢å¼•)                   â”‚
â”‚ â€¢ category (ç´¢å¼•)                   â”‚
â”‚ â€¢ chunk_id                          â”‚
â”‚ â€¢ file_type                         â”‚
â”‚ â€¢ tags                              â”‚
â”‚ â€¢ ... (å…¶ä»–å­—æ®µ)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 12. æœ€ä½³å®è·µ

### 12.1 è®¾è®¡åŸåˆ™
- âœ… å…ƒæ•°æ®ç»“æ„åŒ–ã€æ ‡å‡†åŒ–
- âœ… æ–‡æ¡£åˆ†å—åˆç†ï¼ˆchunk_size=1000ï¼‰
- âœ… ä½¿ç”¨content_hashé˜²æ­¢é‡å¤
- âœ… åˆ†ç±»æ ‡ç­¾è§„èŒƒåŒ–

### 12.2 æ€§èƒ½å»ºè®®
- ğŸ“Š æ‰¹é‡æ“ä½œä¼˜äºå•æ¡æ“ä½œ
- ğŸ¯ åˆç†ä½¿ç”¨Top-Ké™åˆ¶
- ğŸ” å……åˆ†åˆ©ç”¨å…ƒæ•°æ®è¿‡æ»¤
- ğŸ’¾ å®šæœŸå¤‡ä»½æ•°æ®åº“

### 12.3 ç»´æŠ¤å»ºè®®
- ğŸ§¹ å®šæœŸæ¸…ç†é‡å¤æ–‡æ¡£
- ğŸ“ˆ ç›‘æ§æ•°æ®åº“å¤§å°
- ğŸ”„ å®šæœŸé‡å»ºç´¢å¼•ï¼ˆå¤§é‡åˆ é™¤åï¼‰
- ğŸ“ è®°å½•schemaå˜æ›´

---

## 13. å‚è€ƒèµ„æ–™

- [ChromaDB å®˜æ–¹æ–‡æ¡£](https://docs.trychroma.com/)
- [HNSWç®—æ³•è®ºæ–‡](https://arxiv.org/abs/1603.09320)
- [å‘é‡æ•°æ®åº“é€‰å‹æŒ‡å—](https://www.pinecone.io/learn/vector-database/)

---

**æ–‡æ¡£ç»´æŠ¤**: Schemaå˜æ›´æ—¶è¯·åŠæ—¶æ›´æ–°æœ¬æ–‡æ¡£
