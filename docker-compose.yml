version: '3.8'

services:
  knowledge-agent:
    build: .
    container_name: personal_knowledge_agent
    restart: unless-stopped
    ports:
      - "7860:7860"
    volumes:
      # 持久化数据目录
      - ./data:/app/data
      # 持久化日志目录
      - ./logs:/app/logs
      # 用户上传文件（可选）
      - ./user_files:/app/user_files
    environment:
      # 基础配置
      - APP_NAME=个人知识管理助手
      - APP_VERSION=1.0.0
      - DEBUG=false
      - LOG_LEVEL=INFO
      
      # Gradio配置
      - GRADIO_SERVER_HOST=0.0.0.0
      - GRADIO_SERVER_PORT=7860
      - GRADIO_SHARE=false
      
      # 向量数据库配置
      - VECTOR_DB_PATH=./data/vector_db
      - COLLECTION_NAME=knowledge_base
      
      # 文档处理配置
      - CHUNK_SIZE=1000
      - CHUNK_OVERLAP=200
      - TOP_K=5
      
      # Embedding配置（推荐使用免费方案）
      - EMBEDDING_METHOD=all-MiniLM-L6-v2
      
      # API密钥（可选，取消注释后填入）
      # - OPENAI_API_KEY=your_openai_key_here
      # - DEEPSEEK_API_KEY=your_deepseek_key_here
    
    # 资源限制（可选）
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    
    # 健康检查
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:7860')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# 可选：添加网络配置
# networks:
#   default:
#     name: knowledge-agent-network
